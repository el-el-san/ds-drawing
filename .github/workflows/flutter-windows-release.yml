name: Flutter Windows Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: flutter/direct_drawing_generator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          channel: stable
          flutter-version: '3.22.2'
          cache: true

      - name: Ensure Windows platform scaffolding
        run: flutter create --org io.koseri --platforms windows --no-pub .

      - name: Flutter pub get
        run: flutter pub get

      - name: Flutter analyze
        run: flutter analyze

      - name: Run widget tests
        run: flutter test

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          # タグ名から'v'プレフィックスを削除してバージョンを取得
          $TAG_NAME = "${{ github.ref }}" -replace "^refs/tags/", ""
          $VERSION_NAME = $TAG_NAME -replace "^v", ""

          # ビルド番号を生成（コミット数 × 10）
          $BUILD_BASE = (git rev-list --count HEAD)
          $BUILD_NUMBER = [int]$BUILD_BASE * 10

          "tag_name=$TAG_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "version_name=$VERSION_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "build_number=$BUILD_NUMBER" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          @"
          Resolved version components for release
            Tag name: $TAG_NAME
            Version name: $VERSION_NAME
            Build number: $BUILD_NUMBER
          "@ | Tee-Object -FilePath version-info.txt

      - name: Update pubspec.yaml with version
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}"
          Write-Host "Updating pubspec.yaml version to: $VERSION"
          (Get-Content pubspec.yaml) -replace '^version: .*', "version: $VERSION" | Set-Content pubspec.yaml
          Write-Host "Updated pubspec.yaml:"
          Select-String -Path pubspec.yaml -Pattern '^version:'

      - name: Update MSIX version and architecture
        shell: pwsh
        run: |
          $BUILD_NUMBER = "${{ steps.version.outputs.build_number }}"
          $MAJOR = [Math]::Floor([int]$BUILD_NUMBER / 65536) % 65536
          $MINOR = [Math]::Floor([int]$BUILD_NUMBER / 256) % 256
          $BUILD = [int]$BUILD_NUMBER % 256
          $MSIX_VERSION = "${MAJOR}.${MINOR}.${BUILD}.0"
          Write-Host "Updating MSIX version to: $MSIX_VERSION"

          $content = Get-Content pubspec.yaml
          $content = $content -replace 'msix_version: .*', "msix_version: $MSIX_VERSION"
          $content = $content -replace 'architecture: arm64', 'architecture: x64'
          $content | Set-Content pubspec.yaml

      - name: Create test certificate for MSIX signing
        shell: pwsh
        run: |
          $certPath = "ci/test-certificate.pfx"
          $certDir = Split-Path $certPath -Parent
          if (!(Test-Path $certDir)) {
            New-Item -ItemType Directory -Path $certDir -Force
          }

          # Create self-signed certificate for release
          $cert = New-SelfSignedCertificate `
            -Type Custom `
            -Subject "CN=K-OS-ERI Development, O=K-OS-ERI, C=US" `
            -KeyUsage DigitalSignature `
            -FriendlyName "Direct Drawing Generator Test Certificate" `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")

          $certPassword = ConvertTo-SecureString -String "test123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath $certPath -Password $certPassword
          Write-Host "Test certificate created at: $certPath"

      - name: Validate dart-define values
        shell: pwsh
        run: |
          $UPLOAD_ENDPOINT = "${{ secrets.UPLOAD_ENDPOINT }}"
          $UPLOAD_AUTH_ENDPOINT = "${{ secrets.UPLOAD_AUTH_ENDPOINT }}"
          $UPLOAD_TURNSTILE_URL = "${{ secrets.UPLOAD_TURNSTILE_URL }}"

          Write-Host "Validating dart-define values..."
          if ([string]::IsNullOrWhiteSpace($UPLOAD_ENDPOINT)) {
            Write-Error "UPLOAD_ENDPOINT is empty or not set"
            exit 1
          }
          if ([string]::IsNullOrWhiteSpace($UPLOAD_AUTH_ENDPOINT)) {
            Write-Error "UPLOAD_AUTH_ENDPOINT is empty or not set"
            exit 1
          }
          if ([string]::IsNullOrWhiteSpace($UPLOAD_TURNSTILE_URL)) {
            Write-Error "UPLOAD_TURNSTILE_URL is empty or not set"
            exit 1
          }

          Write-Host "✓ UPLOAD_ENDPOINT is set (length: $($UPLOAD_ENDPOINT.Length))"
          Write-Host "✓ UPLOAD_AUTH_ENDPOINT is set (length: $($UPLOAD_AUTH_ENDPOINT.Length))"
          Write-Host "✓ UPLOAD_TURNSTILE_URL is set (length: $($UPLOAD_TURNSTILE_URL.Length))"

      - name: Build Windows executable (release)
        shell: pwsh
        run: |
          flutter build windows --release `
            --build-number=${{ steps.version.outputs.build_number }} `
            --build-name=${{ steps.version.outputs.version_name }} `
            --dart-define="UPLOAD_ENDPOINT=${{ secrets.UPLOAD_ENDPOINT }}" `
            --dart-define="UPLOAD_AUTH_ENDPOINT=${{ secrets.UPLOAD_AUTH_ENDPOINT }}" `
            --dart-define="UPLOAD_TURNSTILE_URL=${{ secrets.UPLOAD_TURNSTILE_URL }}"

      - name: Create MSIX package
        shell: pwsh
        run: |
          dart run msix:create `
            --install-certificate false `
            --windows-build-args "--dart-define=UPLOAD_ENDPOINT=${{ secrets.UPLOAD_ENDPOINT }} --dart-define=UPLOAD_AUTH_ENDPOINT=${{ secrets.UPLOAD_AUTH_ENDPOINT }} --dart-define=UPLOAD_TURNSTILE_URL=${{ secrets.UPLOAD_TURNSTILE_URL }}"

      - name: Rename and prepare release files
        shell: pwsh
        run: |
          $msixFiles = Get-ChildItem -Path . -Filter "*.msix" -Recurse
          if ($msixFiles.Count -eq 0) {
            Write-Error "MSIX file not found"
            exit 1
          }

          $msixPath = $msixFiles[0].FullName
          $newName = "direct-drawing-generator-windows-x64-${{ steps.version.outputs.version_name }}+${{ steps.version.outputs.build_number }}.msix"
          $buildDir = Split-Path $msixPath -Parent
          $newPath = Join-Path $buildDir $newName

          Move-Item -Path $msixPath -Destination $newPath -Force
          Write-Host "Created: $newName"
          Get-Item $newPath | Format-List

          # install-msix.ps1を同じディレクトリにコピー
          $installScriptSource = "..\..\install-msix.ps1"
          $installScriptDest = Join-Path $buildDir "install-msix.ps1"

          if (Test-Path $installScriptSource) {
            Copy-Item -Path $installScriptSource -Destination $installScriptDest -Force
            Write-Host "Copied install-msix.ps1 to build directory"
          } else {
            Write-Warning "install-msix.ps1 not found at $installScriptSource"
          }

          # 環境変数に保存
          "MSIX_PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "BUILD_DIR=$buildDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Generate release notes
        id: release_notes
        shell: pwsh
        run: |
          # 前のタグを取得
          $PREVIOUS_TAG = ""
          $previousTagResult = git describe --tags --abbrev=0 HEAD^ 2>$null

          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrWhiteSpace($previousTagResult)) {
            $PREVIOUS_TAG = $previousTagResult.Trim()
          } else {
            Write-Host "初回リリース: 比較対象タグが見つかりませんでした"
            $global:LASTEXITCODE = 0  # git describe の失敗でワークフローが止まらないようにする
          }

          if ([string]::IsNullOrEmpty($PREVIOUS_TAG)) {
            "初回リリース" | Out-File -FilePath release-notes.md -Encoding utf8
          } else {
            "## 変更履歴`n" | Out-File -FilePath release-notes.md -Encoding utf8
            git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG..HEAD" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          }

          "`n`n## ビルド情報" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "- バージョン: ${{ steps.version.outputs.version_name }}" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "- ビルド番号: ${{ steps.version.outputs.build_number }}" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "- ビルド日時: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "- コミット: $($env:GITHUB_SHA.Substring(0,7))" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "`n## インストール方法`n" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "1. MSIXファイルと``install-msix.ps1``をダウンロード" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "2. 同じフォルダに配置" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "3. ``install-msix.ps1``を右クリック → 「PowerShellで実行」" | Out-File -FilePath release-notes.md -Encoding utf8 -Append
          "4. 管理者権限の確認ダイアログで「はい」をクリック" | Out-File -FilePath release-notes.md -Encoding utf8 -Append

          Get-Content release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Release ${{ steps.version.outputs.version_name }}
          body_path: flutter/direct_drawing_generator/release-notes.md
          files: |
            flutter/direct_drawing_generator/build/windows/x64/runner/Release/direct-drawing-generator-*.msix
            flutter/direct_drawing_generator/build/windows/x64/runner/Release/install-msix.ps1
            flutter/direct_drawing_generator/version-info.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (backup)
        if: success()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: direct-drawing-msix-windows-x64-${{ steps.version.outputs.version_name }}-build${{ steps.version.outputs.build_number }}
          path: |
            flutter/direct_drawing_generator/build/windows/x64/runner/Release/direct-drawing-generator-*.msix
            flutter/direct_drawing_generator/build/windows/x64/runner/Release/install-msix.ps1
            flutter/direct_drawing_generator/version-info.txt
          if-no-files-found: error
